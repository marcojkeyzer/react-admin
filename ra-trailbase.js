// Rev. 0.1.1. Copyright (C) Stellenbosch University. All Rights Reserved. Distribution forbidden.
import{initClientFromCookies as e}from"trailbase";const t=async t=>{let a=()=>localStorage.setItem("auth",JSON.stringify(o.tokens()??null));const r=localStorage.getItem("auth")?JSON.parse(localStorage.getItem("auth")??"null"):void 0,o=await e(t,{tokens:r,onAuthChange:a});a();const s={getList:async(e,t)=>{const{pagination:a,sort:r,filter:s}=t,n={limit:a?.perPage??10,offset:a?(a.page-1)*a.perPage:0},c=[];if(r?.field&&r?.order){const e="DESC"===r.order?"-":"";c.push(`${e}${r.field}`)}const i=[];s&&Object.entries(s).forEach(([e,t])=>{null!=t&&""!==t&&("string"==typeof t?i.push({column:e,op:"like",value:`%${t.toString()}%`}):"number"==typeof t||"boolean"==typeof t?i.push({column:e,op:"equal",value:t.toString()}):"object"==typeof t&&null!==t&&Object.entries(t).forEach(([t,a])=>{let r="equal";switch(t){case"$eq":default:r="equal";break;case"$ne":r="notEqual";break;case"$gt":r="greaterThan";break;case"$gte":r="greaterThanOrEqual";break;case"$lt":r="lessThan";break;case"$lte":r="lessThanOrEqual";break;case"$like":r="like";break;case"$re":r="regexp";break;case"$is":r="is"}i.push({column:e,op:r,value:a?.toString()||""})}))});const l=await o.records(e).list({pagination:n,order:c,filters:i,count:!0});return{data:l.records,total:l.total_count||l.records.length}},getOne:async(e,t)=>{const{id:a}=t;return{data:await o.records(e).read(a)}},getMany:async(e,t)=>{const{ids:a}=t,r=[];for(const t of a){const a=await o.records(e).read(t);r.push(a)}return{data:r}},getManyReference:async(e,t)=>{const{target:a,id:r,filter:o}=t,n=o;return o[a]=r,s.getList(e,{...t,filter:n})},create:async(e,t)=>{const{data:a}=t;console.log("create",a);const r=await o.records(e).create(a);return{data:await o.records(e).read(r)}},update:async(e,t)=>{const{id:a,data:r}=t;return await o.records(e).update(a,r),{data:await o.records(e).read(a)}},updateMany:async(e,t)=>{const{ids:a,data:r}=t,o=[];for(const t of a)s.update(e,{id:t,data:r,previousData:{id:t}}),o.push(t);return{data:o}},delete:async(e,t)=>{const{id:a}=t,r=await o.records(e).read(a);return await o.records(e).delete(a),{data:r}},deleteMany:async(e,t)=>{const{ids:a}=t,r=[];for(const t of a)s.delete(e,{id:t}),r.push(t);return{data:r}}};return{dataProvider:s,authProvider:{async login(e){const{username:t,password:a}=e;return await o.login(t,a),Promise.resolve()},async checkError(e){const{status:t}=e;return 401===t||403===t?(localStorage.removeItem("auth"),Promise.reject()):Promise.resolve()},checkAuth:async()=>(await o.refreshAuthToken(),await o.checkCookies()?Promise.resolve():Promise.reject()),logout:async()=>(await o.logout(),localStorage.removeItem("auth"),Promise.resolve()),async getIdentity(){const e=o.user();return e?Promise.resolve({id:e?.id||"",fullName:e?.email||"",avatar:void 0}):Promise.reject()}}}};export{t as createTrailbaseProvider};